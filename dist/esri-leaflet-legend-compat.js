(function (factory) {
  //define an AMD module that relies on 'leaflet'
  if (typeof define === 'function' && define.amd) {
    define(['leaflet', 'esri-leaflet'], function (L, EsriLeaflet) {
      return factory(L, EsriLeaflet);
    });
  //define a common js module that relies on 'leaflet'
  } else if (typeof module === 'object' && typeof module.exports === 'object') {
    module.exports = factory(require('leaflet'), require('esri-leaflet'));
  }

  if(typeof window !== 'undefined' && window.L){
    factory(window.L, L.esri);
  }
}(function (L, EsriLeaflet) {


EsriLeaflet.Services.MapService.include({legend:function(a,b){return new EsriLeaflet.Tasks.Legend(this).run(a,b)}}),EsriLeaflet.Tasks.Legend=EsriLeaflet.Tasks.Task.extend({path:"legend",params:{f:"json"},run:function(a,b){return this._service?this._service.request(this.path,this.params,a,b):this._request("request",this.path,this.params,a,b)}}),EsriLeaflet.Tasks.legend=function(a){return new EsriLeaflet.Tasks.Legend(a)},EsriLeaflet.Tasks.Legend.include({initialize:function(a){this._renderer=new EsriLeaflet.Tasks.Legend.SymbolRenderer,EsriLeaflet.Tasks.Task.prototype.initialize.call(this,a)},run:function(a,b){function c(c,d){c&&400===c.error.code?this._collectLegendFromLayers(a,b):a.call(b,c,d)}return this._service?this._service.request(this.path,this.params,c,this):this._request("request",this.path,this.params,c,this)},_collectLegendFromLayers:function(a,b){this._service.metadata(function(c,d){if(c)return a.call(b,c);for(var e=[],f=0,g=d.layers.length;g>f;f++)d.layers[f].subLayerIds||e.push(d.layers[f]);this._getLayersLegends(e,function(c,d){c?a.call(b,c):this._symbolsToLegends(d,function(c,d){a.call(b,c,{layers:d})})},this)},this)},_getLayersLegends:function(a,b,c){function d(g,h){g?b.call(c,g):(f.push(h),e=a.pop(),e?this._getLayerLegend(e,d,this):b.call(c,null,f))}var e=a.pop(),f=[];e||b.call(this,null,f),this._getLayerLegend(e,d,this)},_getLayerLegend:function(a,b,c){this._service.request(a.id,{f:"json"},b,c)},_symbolsToLegends:function(a,b,c){function d(g,h){g&&b.call(c,g),e.push({layerId:f.id,layerType:f.type,layerName:f.name,maxScale:f.maxScale,minScale:f.minScale,legend:h}),f=a.pop(),f?this._drawingInfoToLegend(f.drawingInfo,d,this):b.call(c,null,e)}var e=[],f=a.pop();return f&&this._drawingInfoToLegend(f.drawingInfo,d,this),e},_drawingInfoToLegend:function(a,b,c){function d(a,h){return a?b.call(c,a):(f.push({label:g.label,height:h.height,url:g.symbol.url,imageData:h.imageData,contentType:h.contentType,width:h.width,values:[g.value||""]}),g=e.pop(),void(g?this._renderSymbol(g,d,this):b.call(c,null,f)))}var e="uniqueValue"===a.renderer.type?a.renderer.uniqueValueInfos.slice():[a.renderer],f=[],g=e.pop();g&&this._renderSymbol(g,d,this)},_renderSymbol:function(a,b,c){return this._renderer.render(a.symbol,b,c)}}),EsriLeaflet.Tasks.Legend.SymbolRenderer=L.Class.extend({statics:{SYMBOL_TYPES:{MARKER:"esriSMS",LINE:"esriSLS",FILL:"esriSFS",PICTURE_MARKER:"esriPMS",PICTURE_FILL:"esriPFS",TEXT:"esriTS"}},render:function(a,b,c){function d(d,e){d?b.call(c,d):b.call(c,null,{width:a.width,height:a.height,imageData:e,url:null,contentType:"image/png"})}var e=document.createElement("canvas"),f=e.getContext("2d");a.imageData;if(a.imageData)return d(null,a.imageData);switch(a.type){case"esriSMS":this._renderMarker(f,a,d);break;case"esriSLS":this._renderLine(f,a,d);break;case"esriSFS":this._renderFill(f,a,d);break;case"esriPMS":this._renderImageMarker(f,a,d);break;case"esriPFS":this._renderImageFill(f,a,d);break;case"esriST":this._renderText(f,a,d)}},_renderText:function(a,b,c){console.log(b),this._setSize(a,b),c(null,a.getImageData(0,0,b.width,b.height))},_renderFill:function(a,b,c){console.log(b),this._setSize(a,b),c(null,a.getImageData(0,0,b.width,b.height))},_renderLine:function(a,b,c){console.log(b),this._setSize(a,b),c(null,a.getImageData(0,0,b.width,b.height))},_renderMarker:function(a,b,c){console.log(b),this._setSize(a,b),b.outline&&this._setOutline(a,b.outline),c(null,a.getImageData(0,0,b.width,b.height))},_renderImageFill:function(a,b,c){this._setRotation(a,b.angle),b.imageData?(this._fillImage(a,b.imageData,b,b.contentType),c(null,a.toDataURL())):this._loadImage(b.url,function(d,e){this._fillImage(a,null,b,b.contentType,e),c(null,a.toDataURL())},this)},_renderImageMarker:function(a,b,c){this._setSize(a,b),this._setRotation(a,b.angle),b.imageData?(this._drawImage(a,b.imageData,b.contentType),c(null,a.toDataURL())):this._loadImage(b.url,function(b,d){a.drawImage(d,0,0),c(null,a.toDataURL())},this)},_setSize:function(a,b){a.width=b.width,a.height=b.height},_setRotation:function(a,b){a.rotate(-parseFloat(b)*Math.PI/180)},_getImageData:function(a,b){return a.toDImageData(0,0,b.width,b.height)},_fillImage:function(a,b,c,d,e){b&&(e=new Image,e.src="data:"+d+";base64,"+b);var f=a.createPattern(e,"repeat");a.rect(0,0,c.width,c.height),a.fillStyle=f,a.fill()},_drawImage:function(a,b,c){var d=new Image;d.src="data:"+c+";base64,"+b,a.drawImage(d,0,0)},_loadImage:function(a,b,c){var d=new Image;d.crossOrigin="",d.onload=function(){b.call(c,null,this)},d.onerror=function(a){b.call(c,{code:500})},d.src=a+(-1===a.indexOf("?")?"?":"&")+"nc="+(new Date).getTime()}}),EsriLeaflet.Layers.DynamicMapLayer.include({legend:function(a,b){return this._service.legend(a,b)}}),EsriLeaflet.Layers.FeatureLayer.include({legend:function(){return this._service.legend()}});
//# sourceMappingURL=esri-leaflet-legend-compat.js.map

  return EsriLeaflet;
}));