{"version":3,"file":"esri-leaflet-legend-compat.js","sources":["../src/Util.js","../src/Services/MapService.js","../src/Services/FeatureLayer.js","../src/Tasks/Legend.js","../src/Tasks/Legend/SymbolLegend.js","../src/Tasks/Legend/SymbolRenderer.js","../src/Layers/DynamicMapLayer.js","../src/Layers/FeatureLayer/FeatureLayer.js","../src/Controls/Legend.js"],"names":["EsriLeaflet","Util","reduce","values","initial","fn","cb","context","next","index","sync","i","length","done","curr","err","val","callback","call","Services","MapService","include","legend","Tasks","Legend","this","run","FeatureLayer","Task","extend","path","params","f","_service","request","_request","initialize","endpoint","_renderer","SymbolRenderer","prototype","error","response","code","_collectLegendFromLayers","drawingInfo","_symbolsToLegends","result","layers","metadata","len","subLayerIds","push","_getLayersLegends","layerData","layerDefs","self","layer","_getLayerLegend","data","concat","id","_drawingInfoToLegend","layerId","layerType","type","layerName","name","maxScale","minScale","_getRendererSymbols","renderer","symbols","uniqueValueInfos","slice","classBreakInfos","symbol","label","description","value","defaultSymbol","defaultLabel","_renderSymbol","image","height","url","imageData","contentType","width","render","L","Class","statics","SYMBOL_TYPES","MARKER","LINE","FILL","PICTURE_MARKER","PICTURE_FILL","TEXT","DEFAULT_SIZE","canvas","replace","document","createElement","ctx","getContext","_setSize","_renderMarker","_renderLine","_renderFill","_renderImageMarker","_renderImageFill","_renderText","console","log","toDataURL","size","lineWidth","outline","lineOffset","Math","max","style","_hatchCanvas","color","_setRotation","fillStyle","_formatColor","fillRect","Error","strokeStyle","_setDashArray","rect","stroke","beginPath","moveTo","lineTo","closePath","r","rx","ry","xoffset","yoffset","angle","arc","PI","fill","_fillImage","_loadImage","_drawImage","drawImage","rotate","parseFloat","dashArray","_formatDashArray","setLineDash","_drawCross","offset","w","h","join","dashValues","_getImageData","toDImageData","Image","src","pattern","createPattern","crossOrigin","onload","onerror","e","indexOf","Date","getTime","Layers","DynamicMapLayer","Controls","Control","options","_layers","isArray","onAdd","map","container","DomUtil","create","DomEvent","disableScrollPropagation","disableClickPropagation","_load","esri","_onLoad","html","j","jj","layerLegend","_validateLegendLabel","template","_container","innerHTML"],"mappings":"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","sourcesContent":["/**\n * @example\n * <code>\n * L.esri.Util.queue(\n *   [1, 2, 3], [], function(curr, item, cb){\n *     setTimeout(function(){\n *       cb(null, curr.concat([item + 10]));\n *     }, 200);\n *   }, function(err, result) {\n *     console.log(result); // [11, 12, 13]\n * });\n * </code>\n * @param  {Array.<*>} values\n * @param  {*}         initial\n * @param  {Function}  fn       process item fn(memo, item, callback)\n * @param  {Function}  done     queue complete\n * @param  {*=}        context\n */\nEsriLeaflet.Util.reduce = function(values, initial, fn, cb, context) {\n  var curr = initial;\n\n  function next(index) {\n    var sync = true;\n    for (var i = index; i < values.length; i++) {\n      var done = false;\n      fn(curr, values[i], function(err, val) {\n        if (err) {\n          return cb.callback(context, err, curr);\n        }\n        done = true;\n        curr = val;\n        if (!sync) {\n          next(i + 1);\n        }\n      });\n      sync = done;\n      if (!sync) {\n        return;\n      }\n    }\n    cb.call(context, null, curr);\n  }\n\n  next(0);\n};\n","EsriLeaflet.Services.MapService.include({\n\n  legend: function(callback, context) {\n    return new EsriLeaflet.Tasks.Legend(this).run(callback, context);\n  }\n\n});\n","EsriLeaflet.Services.FeatureLayer.include({\n\n  legend: function(callback, context) {\n    return new EsriLeaflet.Tasks.Legend(this).run(callback, context);\n  }\n\n});\n","EsriLeaflet.Tasks.Legend = EsriLeaflet.Tasks.Task.extend({\n  path: 'legend',\n\n  params: {\n    f: 'json'\n  },\n\n  run: function(callback, context) {\n    if (this._service) {\n      return this._service.request(this.path, this.params, callback, context);\n    } else {\n      return this._request('request', this.path, this.params, callback, context);\n    }\n  }\n\n});\n\nEsriLeaflet.Tasks.legend = function(params) {\n  return new EsriLeaflet.Tasks.Legend(params);\n};\n","EsriLeaflet.Tasks.Legend.include({\n\n  initialize: function(endpoint) {\n    this._renderer = new EsriLeaflet.Tasks.Legend.SymbolRenderer();\n    EsriLeaflet.Tasks.Task.prototype.initialize.call(this, endpoint);\n  },\n\n  run: function(callback, context) {\n    function cb(error, response) {\n      if (error && error.error.code === 400) { // ArcGIS server >=10.0\n        this._collectLegendFromLayers(callback, context);\n      } else if (response.drawingInfo) {\n        this._symbolsToLegends([response], function(err, result) {\n          callback.call(context, err, {\n            layers: result\n          });\n        });\n      } else {\n        callback.call(context, error, response);\n      }\n    }\n\n    if (this._service) {\n      return this._service.request(this.path, this.params, cb, this);\n    } else {\n      return this._request('request', this.path, this.params, cb, this);\n    }\n  },\n\n  _collectLegendFromLayers: function(callback, context) {\n    this._service.metadata(function(error, response) {\n      if (error) {\n        return callback.call(context, error);\n      }\n\n      var layers = [];\n      for (var i = 0, len = response.layers.length; i < len; i++) {\n        if (!response.layers[i].subLayerIds) {\n          layers.push(response.layers[i]);\n        }\n      }\n\n      this._getLayersLegends(layers, function(err, layerData) {\n        if (err) {\n          callback.call(context, err);\n        } else {\n          this._symbolsToLegends(layerData, function(err, result) {\n            callback.call(context, err, {\n              layers: result\n            });\n          });\n        }\n      }, this);\n    }, this);\n  },\n\n  _getLayersLegends: function(layerDefs, callback, context) {\n    var layerData = [];\n    var self = this;\n\n    EsriLeaflet.Util.reduce(layerDefs, [], function(curr, layer, cb) {\n      self._getLayerLegend(layer, function(err, data) {\n        if (err) {\n          return cb(err, null);\n        }\n        cb(null, curr.concat(data));\n      }, self);\n    }, function(err, result) {\n      callback.call(context, err, result);\n    });\n  },\n\n  _getLayerLegend: function(layer, callback, context) {\n    this._service.request(layer.id, {\n      f: 'json'\n    }, callback, context);\n  },\n\n  _symbolsToLegends: function(layerData, callback, context) {\n    var self = this;\n    EsriLeaflet.Util.reduce(layerData, [], function(curr, layer, cb) {\n      self._drawingInfoToLegend(layer.drawingInfo, function(err, legend) {\n        if (err) {\n          return cb(err, null);\n        }\n        cb(null, curr.concat([{\n          layerId: layer.id,\n          layerType: layer.type,\n          layerName: layer.name,\n          maxScale: layer.maxScale,\n          minScale: layer.minScale,\n          legend: legend\n        }]));\n      }, self);\n    }, function(err, result) {\n      callback.call(context, err, result);\n    });\n  },\n\n  _getRendererSymbols: function(renderer) {\n    var symbols;\n    if (renderer.type === 'uniqueValue') {\n      symbols = renderer.uniqueValueInfos.slice();\n    } else if (renderer.type === 'classBreaks') {\n      symbols = renderer.classBreakInfos.slice();\n    } else if (renderer.type === 'simple') {\n      symbols = [{\n        symbol: renderer.symbol,\n        label: renderer.label,\n        description: renderer.description,\n        value: renderer.value\n      }];\n    }\n    if (renderer.defaultSymbol) {\n      symbols.push({\n        symbol: renderer.defaultSymbol,\n        label: renderer.defaultLabel,\n        description: '',\n        value: null\n      });\n    }\n    return symbols;\n  },\n\n  _drawingInfoToLegend: function(drawingInfo, callback, context) {\n    var self = this;\n    EsriLeaflet.Util.reduce(\n      this._getRendererSymbols(drawingInfo.renderer), [],\n      function(curr, symbol, cb) {\n        self._renderSymbol(symbol, function(err, image) {\n          if (err) {\n            return cb(err, curr);\n          }\n          cb(null, curr.concat([{\n            label: symbol.label,\n            height: image.height,\n            url: symbol.symbol.url,\n            imageData: image.imageData,\n            contentType: image.contentType,\n            width: image.width,\n            values: [symbol.value || '']\n          }]));\n        }, self);\n      },\n      function(err, legend) {\n        callback.call(context, err, legend);\n      });\n  },\n\n  _renderSymbol: function(symbol, callback, context) {\n    return this._renderer.render(symbol.symbol, callback, context);\n  }\n\n});\n","EsriLeaflet.Tasks.Legend.SymbolRenderer = L.Class.extend({\n\n  statics: {\n    SYMBOL_TYPES: {\n      MARKER: 'esriSMS',\n      LINE: 'esriSLS',\n      FILL: 'esriSFS',\n      PICTURE_MARKER: 'esriPMS',\n      PICTURE_FILL: 'esriPFS',\n      TEXT: 'esriTS'\n    },\n    DEFAULT_SIZE: 20\n  },\n\n  render: function(symbol, callback, context) {\n    var canvas = document.createElement('canvas');\n    var ctx = canvas.getContext('2d');\n    var imageData = symbol.imageData;\n    this._setSize(canvas, symbol);\n\n    function done(error, imageData) {\n      if (error) {\n        callback.call(context, error);\n      } else {\n        callback.call(context, null, {\n          width: canvas.width || EsriLeaflet.Tasks.Legend.SymbolRenderer.DEFAULT_SIZE,\n          height: canvas.height || EsriLeaflet.Tasks.Legend.SymbolRenderer.DEFAULT_SIZE,\n          imageData: imageData.replace('data:image/png;base64,', ''),\n          url: null,\n          contentType: 'image/png'\n        });\n      }\n    }\n\n    if (symbol.imageData) {\n      return done(null, symbol.imageData);\n    }\n\n    switch (symbol.type) {\n      case 'esriSMS':\n        this._renderMarker(ctx, symbol, done);\n        break;\n      case 'esriSLS':\n        this._renderLine(ctx, symbol, done);\n        break;\n      case 'esriSFS':\n        this._renderFill(ctx, symbol, done);\n        break;\n      case 'esriPMS':\n        this._renderImageMarker(ctx, symbol, done);\n        break;\n      case 'esriPFS':\n        this._renderImageFill(ctx, symbol, done);\n        break;\n      case 'esriST':\n        this._renderText(ctx, symbol, done);\n        break;\n      default:\n        break;\n    }\n  },\n\n  _renderText: function(ctx, symbol, callback) {\n    console.log(symbol);\n    callback(null, ctx.canvas.toDataURL());\n  },\n\n  _renderFill: function(ctx, symbol, callback) {\n    var size = EsriLeaflet.Tasks.Legend.SymbolRenderer.DEFAULT_SIZE;\n    var lineWidth = symbol.outline ? symbol.outline.width : 1;\n    var lineOffset = Math.max(5, lineWidth * 3);\n    switch (symbol.style) {\n\n      case 'esriSFSVertical':\n        this._hatchCanvas(ctx, size, symbol.color, lineWidth, lineOffset);\n        break;\n\n      case 'esriSFSHorizontal':\n        this._setRotation(ctx, 90);\n        this._hatchCanvas(ctx, size, symbol.color, lineWidth, lineOffset);\n        break;\n\n      case 'esriSFSBackwardDiagonal':\n        this._setRotation(ctx, -45);\n        this._hatchCanvas(ctx, size, symbol.color, lineWidth, lineOffset);\n        break;\n\n      case 'esriSFSForwardDiagonal':\n        this._setRotation(ctx, 45);\n        this._hatchCanvas(ctx, size, symbol.color, lineWidth, lineOffset);\n        break;\n\n      case 'esriSFSCross':\n        this._hatchCanvas(ctx, size, symbol.color, lineWidth, lineOffset);\n        this._setRotation(ctx, 90);\n        this._hatchCanvas(ctx, size, symbol.color, lineWidth, lineOffset);\n        break;\n\n      case 'esriSFSDiagonalCross':\n        this._setRotation(ctx, 45);\n        this._hatchCanvas(ctx, size, symbol.color, lineWidth, lineOffset);\n        this._setRotation(ctx, 45);\n        this._hatchCanvas(ctx, size, symbol.color, lineWidth, lineOffset);\n        break;\n\n      case 'esriSFSSolid':\n        ctx.fillStyle = this._formatColor(symbol.color);\n        ctx.fillRect(0, 0, size, size);\n        break;\n\n      case 'esriSFSNull':\n        break;\n\n      default:\n        throw new Error('Unknown SFS style: ' + symbol.style);\n    }\n\n    if (symbol.outline) {\n      ctx.strokeStyle = this._formatColor(symbol.outline.color);\n      ctx.lineWidth = symbol.outline.width;\n      ctx.fillStyle = this._formatColor([0, 0, 0, 0]);\n      this._setDashArray(ctx, symbol.outline);\n      ctx.rect(symbol.outline.width, symbol.outline.width,\n        size - symbol.outline.width, size - symbol.outline.width);\n      ctx.stroke();\n    }\n\n    callback(null, ctx.canvas.toDataURL());\n  },\n\n  _renderLine: function(ctx, symbol, callback) {\n    var size = EsriLeaflet.Tasks.Legend.SymbolRenderer.DEFAULT_SIZE;\n    ctx.beginPath();\n    ctx.lineWidth = symbol.width;\n    ctx.strokeStyle = this._formatColor(symbol.color);\n    this._setDashArray(ctx, symbol); //\n\n    ctx.moveTo(0, size / 2);\n    ctx.lineTo(size, size / 2);\n\n    ctx.closePath();\n    ctx.stroke();\n    callback(null, ctx.canvas.toDataURL());\n  },\n\n  _renderMarker: function(ctx, symbol, callback) {\n    var xoffset = 0;\n    var yoffset = 0;\n    var size = symbol.size;\n    var r, rx, ry;\n\n    ctx.beginPath();\n\n    if (symbol.outline) {\n      ctx.strokeStyle = this._formatColor(symbol.outline.color);\n      ctx.lineWidth = symbol.outline.width;\n      xoffset += symbol.outline.width;\n      yoffset += symbol.outline.width;\n    }\n\n    this._setRotation(ctx, symbol.angle);\n\n    switch (symbol.style) {\n      case 'esriSMSCircle':\n        ctx.fillStyle = this._formatColor(symbol.color);\n        r = (size - 2 * xoffset) / 2;\n        ctx.arc(r + xoffset, r + xoffset, r, 0, 2 * Math.PI, false);\n        ctx.fill();\n        break;\n\n      case 'esriSMSX':\n        ctx.moveTo(xoffset, yoffset);\n        ctx.lineTo(size - xoffset, size - yoffset);\n        ctx.moveTo(size - xoffset, yoffset);\n        ctx.lineTo(xoffset, size - yoffset);\n        break;\n\n      case 'esriSMSCross':\n        ctx.moveTo(xoffset, size / 2);\n        ctx.lineTo(size - xoffset, size / 2);\n        ctx.moveTo(size / 2, yoffset);\n        ctx.lineTo(size / 2, size - yoffset);\n        break;\n\n      case 'esriSMSDiamond':\n        ctx.fillStyle = this._formatColor(symbol.color);\n        rx = (size - 2 * xoffset) / 2;\n        ry = (size - 2 * yoffset) / 2;\n\n        console.log(symbol);\n\n        ctx.moveTo(xoffset, yoffset + ry);\n        ctx.lineTo(xoffset + rx, yoffset);\n        ctx.lineTo(xoffset + rx * 2, yoffset + ry);\n        ctx.lineTo(xoffset + rx, yoffset + 2 * ry);\n        ctx.lineTo(xoffset, yoffset + ry);\n        ctx.fill();\n        break;\n\n      case 'esriSMSSquare':\n        ctx.rect(xoffset, yoffset, size - 2 * xoffset, size - 2 * yoffset);\n        break;\n\n      case 'esriSMSTriangle':\n        ctx.fillStyle = this._formatColor(symbol.color);\n        rx = (size - 2 * xoffset) / 2;\n        ry = (size - 2 * yoffset) / 2;\n        ctx.moveTo(xoffset, yoffset + ry * 2);\n        ctx.lineTo(xoffset + rx, yoffset);\n        ctx.lineTo(xoffset + rx * 2, yoffset + ry * 2);\n        ctx.lineTo(xoffset, yoffset + ry * 2);\n        ctx.fill();\n        break;\n\n      default:\n        throw new Error('Unknown esriSMS style: ' + symbol.style);\n    }\n\n    ctx.closePath();\n    if (symbol.outline) {\n      ctx.stroke();\n    }\n    callback(null, ctx.canvas.toDataURL());\n  },\n\n  _renderImageFill: function(ctx, symbol, callback) {\n    this._setRotation(ctx, symbol.angle);\n    if (symbol.imageData) {\n      this._fillImage(ctx, symbol.imageData, symbol, symbol.contentType);\n      callback(null, ctx.toDataURL());\n    } else {\n      this._loadImage(symbol.url, function(err, image) {\n        this._fillImage(ctx, null, symbol, symbol.contentType, image);\n        callback(null, ctx.canvas.toDataURL());\n      }, this);\n    }\n  },\n\n  _renderImageMarker: function(ctx, symbol, callback) {\n    this._setRotation(ctx, symbol.angle);\n    if (symbol.imageData) {\n      this._drawImage(ctx, symbol.imageData, symbol.contentType);\n      callback(null, ctx.toDataURL());\n    } else {\n      this._loadImage(symbol.url, function(err, image) {\n        ctx.drawImage(image, 0, 0);\n        callback(null, ctx.canvas.toDataURL());\n      }, this);\n    }\n  },\n\n  _setSize: function(ctx, symbol) {\n    if (symbol.size) {\n      ctx.width = ctx.height = symbol.size;\n    } else if (symbol.type === 'esriSLS' ||\n      symbol.type === 'esriSFS') {\n      ctx.width = ctx.height = EsriLeaflet.Tasks.Legend.SymbolRenderer.DEFAULT_SIZE;\n    } else {\n      ctx.width = symbol.width;\n      ctx.height = symbol.height;\n    }\n  },\n\n  _setRotation: function(ctx, angle) {\n    ctx.rotate(-parseFloat(angle) * Math.PI / 180);\n  },\n\n  _setDashArray: function(ctx, symbol) {\n    var dashArray = this._formatDashArray(symbol);\n    if (dashArray.length) {\n      ctx.setLineDash(dashArray);\n    }\n  },\n\n  _drawCross: function(ctx, xoffset, yoffset, size) {\n    ctx.moveTo(xoffset, yoffset);\n    ctx.lineTo(size - xoffset, size - yoffset);\n    ctx.moveTo(size - xoffset, yoffset);\n    ctx.lineTo(xoffset, size - yoffset);\n  },\n\n  _hatchCanvas: function(ctx, size, color, width, offset) {\n    var w = size * 2;\n    var h = size * 2;\n\n    for (var i = -w; i < w; i += offset) {\n      ctx.moveTo(i, -h);\n      ctx.lineTo(i, h);\n    }\n\n    ctx.lineWidth = width;\n    ctx.strokeStyle = this._formatColor(color);\n    ctx.stroke();\n  },\n\n  _formatColor: function(color) {\n    return 'rgba(' + color.slice(0, 3).join(',') + ',' + color[3] / 255 + ')';\n  },\n\n  _formatDashArray: function(symbol) {\n    var dashValues = [];\n\n    switch (symbol.style) {\n      case 'esriSLSDash':\n        dashValues = [4, 3];\n        break;\n      case 'esriSLSDot':\n        dashValues = [1, 3];\n        break;\n      case 'esriSLSDashDot':\n        dashValues = [8, 3, 1, 3];\n        break;\n      case 'esriSLSDashDotDot':\n        dashValues = [8, 3, 1, 3, 1, 3];\n        break;\n    }\n\n    //use the dash values and the line weight to set dash array\n    if (dashValues.length > 0) {\n      for (var i = 0, len = dashValues.length; i < len; i++) {\n        dashValues[i] *= symbol.width;\n      }\n    }\n\n    return dashValues;\n  },\n\n  _getImageData: function(ctx, symbol) {\n    return ctx.toDImageData(0, 0, symbol.width, symbol.height);\n  },\n\n  _fillImage: function(ctx, imageData, symbol, contentType, image) {\n    var size = L.EsriLeaflet.Tasks.Legend.DEFAULT_SIZE;\n    var w = symbol.width || size;\n    var h = symbol.height || size;\n    if (imageData) {\n      image = new Image();\n      image.src = 'data:' + contentType + ';base64,' + imageData;\n    }\n\n    var pattern = ctx.createPattern(image, 'repeat');\n    ctx.rect(0, 0, w, h);\n    ctx.fillStyle = pattern;\n    ctx.fill();\n\n    if (symbol.outline) {\n      ctx.strokeStyle = this._formatColor(symbol.outline.color);\n      ctx.lineWidth = symbol.outline.width;\n      ctx.fillStyle = this._formatColor([0, 0, 0, 0]);\n      this._setDashArray(ctx, symbol.outline);\n      ctx.rect(symbol.outline.width, symbol.outline.width,\n        w - symbol.outline.width, h - symbol.outline.width);\n      ctx.stroke();\n    }\n  },\n\n  _drawImage: function(ctx, imageData, contentType) {\n    var image = new Image();\n    image.src = 'data:' + contentType + ';base64,' + imageData;\n    ctx.drawImage(image, 0, 0);\n  },\n\n  _loadImage: function(url, callback, context) {\n    var image = new Image();\n    image.crossOrigin = '';\n    image.onload = function() {\n      callback.call(context, null, this);\n    };\n    image.onerror = function(e) {\n      callback.call(context, {\n        code: 500\n      });\n    };\n    image.src = url + (url.indexOf('?') === -1 ? '?' : '&') +\n      'nc=' + (new Date()).getTime();\n  }\n\n});\n","EsriLeaflet.Layers.DynamicMapLayer.include({\n\n  legend: function(callback, context) {\n    return this._service.legend(callback, context);\n  }\n\n});\n","EsriLeaflet.Layers.FeatureLayer.include({\n\n  legend: function(callback, context) {\n    return this._service.legend(callback, context);\n  }\n\n});\n","EsriLeaflet.Controls.Legend = L.Control.extend({\n\n  initialize: function(layers, options) {\n    this._layers = L.Util.isArray(layers) ? layers : [layers];\n    L.Control.prototype.initialize.call(this, options);\n  },\n\n  onAdd: function(map) {\n    var container = L.DomUtil.create('div', 'leaflet-legend-control leaflet-bar');\n    L.DomEvent\n      .disableScrollPropagation(container)\n      .disableClickPropagation(container);\n\n    if (this._layers.length) {\n      this._load();\n    }\n    return container;\n  },\n\n  _load: function() {\n    L.esri.Util.reduce(this._layers, {\n      layers: []\n    }, function(curr, layer, cb) {\n      layer.legend(function(err, legend) {\n        if (err) {\n          return cb(err, curr);\n        }\n        curr.layers = curr.layers.concat(legend.layers);\n        cb(null, curr);\n      });\n    }, this._onLoad, this);\n  },\n\n  _onLoad: function(error, legend) {\n    if (!error) {\n      var html = '<ul>';\n      for (var i = 0, len = legend.layers.length; i < len; i++) {\n        html += '<li><strong>' + legend.layers[i].layerName + '</strong><ul>';\n        for (var j = 0, jj = legend.layers[i].legend.length; j < jj; j++) {\n          var layerLegend = legend.layers[i].legend[j];\n          this._validateLegendLabel(layerLegend);\n          html += L.Util.template(\n            '<li><img width=\"{width}\" height=\"{height}\" src=\"data:{contentType};base64,{imageData}\"><span>{label}</span></li>',\n            layerLegend);\n        }\n        html += '</ul></li>';\n      }\n      html += '</ul>';\n      this._container.innerHTML = html;\n    }\n  },\n\n  _validateLegendLabel: function(layerLegend) {\n    if (!layerLegend.label) {\n      layerLegend.label = '<all values>';\n    }\n    layerLegend.label = layerLegend.label.replace(/&/g, '&amp;')\n      .replace(/\"/g, '&quot;')\n      .replace(/'/g, '&#39;')\n      .replace(/</g, '&lt;')\n      .replace(/>/g, '&gt;');\n  }\n\n});\n\nEsriLeaflet.Controls.legend = function(layers, options) {\n  return new L.esri.Controls.Legend(layers, options);\n};\n"]}